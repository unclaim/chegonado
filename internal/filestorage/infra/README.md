# S3-репозиторий для хранения файлов
Этот пакет предоставляет реализацию репозитория для работы с файлами в S3-совместимом хранилище. Он создан для использования в рамках приложения и реализует основные операции: сохранение, удаление и проверку существования файлов. Также имеется функция для генерации и сохранения аватаров по умолчанию.
Репозиторий использует AWS SDK for Go (v2), что обеспечивает высокую производительность и надёжность.
# Требования
Go (версия 1.16 или выше)
Доступ к S3-совместимому хранилищу
Пакет github.com/unclaim/chegonado.git для доступа к конфигурации и утилитам.
# Зависимости Go:
```go
go get github.com/aws/aws-sdk-go-v2/config
go get github.com/aws/aws-sdk-go-v2/credentials
go get github.com/aws/aws-sdk-go-v2/service/s3
```

# Конфигурация
Репозиторий загружает свои настройки из структуры cfg.AppConfig, которая, в свою очередь, читает данные из файла config.yaml. Убедитесь, что в этом файле правильно настроены параметры S3.
Пример config.yaml:
```yaml
fileStorage:
  s3:
    endpoint: "http://127.0.0.1:9000" # URL вашего S3-совместимого хранилища
    accessKeyID: "your_access_key_id"
    secretAccessKey: "your_secret_access_key"
    bucket: "your-bucket-name"

```
# Обзор и использование
S3Repository реализует интерфейс, который позволяет абстрагировать логику работы с файлами от основной части приложения.
Создание репозитория (NewS3Repository)
Создаёт и инициализирует новый экземпляр S3Repository. Функция автоматически настраивает S3-клиент, используя предоставленные учётные данные и эндпоинт.
Ключевые особенности:
Используется config.LoadDefaultConfig для загрузки конфигурации, что является рекомендуемым способом в v2.
Эндпоинт и учётные данные для S3-хранилища берутся из объекта конфигурации.
Опция UsePathStyle = true устанавливается для совместимости с большинством S3-совместимых хранилищ (например, MinIO).
Сохранение файла (SaveFile)
Сохраняет файл в S3. Эта функция принимает путь, по которому нужно сохранить файл, и io.Reader с его содержимым. Она возвращает полный URL-адрес сохранённого файла.
Ключевые особенности:
Используется r.s3Client.PutObject для загрузки файла.
Перед загрузкой содержимое io.Reader читается в буфер, чтобы S3-клиент мог корректно определить размер и тип данных.
Возвращаемый URL формируется с использованием эндпоинта, бакета и пути к файлу, определённых в конфигурации.
Удаление файла (DeleteFile)
Удаляет файл из S3 по указанному пути. Функция вызывает r.s3Client.DeleteObject, который отправляет запрос на удаление объекта.
Проверка существования файла (CheckFileExists)
Проверяет, существует ли файл в S3, не скачивая его. Эта функция использует r.s3Client.HeadObject, который возвращает метаданные объекта, не передавая его содержимое. Если объект не найден, возвращается false и nil в качестве ошибки.
Ключевые особенности:
Обработка ошибки types.NotFound. Это идиоматичный способ проверки несуществующего файла в AWS SDK v2 с помощью errors.As.
Создание аватара по умолчанию (CreateDefaultAvatar)
Эта вспомогательная функция создаёт аватар по умолчанию для пользователя на основе его email, сохраняет его в S3 и возвращает URL.
Как это работает:
Генерируется временный файл для аватара.
Вызывается функция utils.GenerateAvatar для создания изображения и записи его во временный файл.
Временный файл загружается в S3 по пути, который включает ID пользователя.
Возвращается полный URL-адрес сохранённого аватара.
# Обновление до AWS SDK v2: Ключевые изменения
Этот репозиторий был полностью написан с использованием AWS SDK v2, но для справки, вот как основные подходы v2 отличаются от v1.
Функция / Метод (v1)
Обновление (v2)
Описание
session.NewSession()
config.LoadDefaultConfig()
Инициализация конфигурации стала более модульной. LoadDefaultConfig автоматически загружает настройки из окружения и файлов конфигурации.
s3.PutObjectWithContext()
s3.PutObject()
Все вызовы API теперь принимают context.Context в качестве первого аргумента. Это позволяет контролировать время выполнения и отмену операций.
awserr.Error (для проверки ошибок)
errors.As (для проверки ошибок)
В v2 для проверки конкретных типов ошибок (например, types.NotFound) используется стандартная библиотека errors.As.
client.Endpoint (непрямой доступ)
client.Options().BaseEndpoint
URL эндпоинта теперь доступен через client.Options(). Он возвращает *string, поэтому его нужно разыменовать для использования в форматировании строк, например, с помощью aws.ToString().

